<!DOCTYPE html>
<meta charset="utf-8"/>
<!--
Project 3 HTML page
ECEN 5783 - Embedded Interface Design
10/14/2019
Authors: Brian Ibeling and Connor Shapiro

The project3_webclient.html page provides a browser-based HTML client interface
to communicate with the AWS Simple Queue Service (SQS), specifically supporting
pulling down JSON-formatted humidity/temperature records from the queue which
have been generated by a Raspberry Pi pushing the records into AWS (first via
AWS IoT, then through AWS Lambda to the queue).
EXTRA CREDIT: This page also provides an approximate count of the number of
records in the queue.

The HTML page reports to the user the following error/warning conditions:
  - Request for message(s) from SQS fails
  - Request for message(s) from SQS cannot be completed because queue is empty
  - Request for approx. number of messages in queue is not fulfilled by SQS

+ Resources and Citations +
The following resources were used to assist with development of this SW.
  - https://w3schools.com/  (too many helpful pages on HTML tags and javascript tips to list)
-->

<html>
  <head>
    <title>Magic Wand Dashboard</title>

    <style>
      h1 {
        text-align: center;
      }

      h2 {
        text-align: center;
      }

      .topButtons {
        text-align: center;
      }

      .button {
        background: none;
        border: none;
      }

      .available {
        font-weight: bold;
      }

      .unavailable {
        color: grey;
      }

      .imageHolder {
        width: 50%;
        height: 450px;
        margin: auto;
      }

      .image {
        width: 65%;
        height: 100%;
        float: left;
      }

      img.center {
        display: block;
        margin-left: auto;
        margin-right: 0%;
      }

      p.caption {
        text-align: right;
        font-size: 18px;
        margin-right: 10%;
      }

      .timestamp {
        width: 35%;
        height: 100%;
        float: right;
      }

      p.timestamp {
        width: 100%;
        text-align: left;
      }

    </style>

  </head>
  <body>
    <div>
      <!-- 

       -->
      <h1>Magic Wand Image Webpage</h1>
      <div class="topButtons">
        <input type="button" onclick="window.location.href = 'magicwand_webclient.html';" value="Back to Main Page">
        <br><br>
        <button disabled="true" class="button unavailable" id="previous">&lt;  Previous 10 Images</button>
        <button disabled="true" class="button unavailable" id="previous">Next 10 Images  &gt;</button>
      </div>
      <br>
      <div class="imageHolder">
        <div class="image">
          <img id="image0" src="" title="First of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label0"></p>
        </div>
        <div class="timestamp">
          <br><p class="timestamp" id="timestamp0"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image1" src="" title="Second of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label1"></p>
        </div>
        <div class="timestamp">
          <br><p class="timestamp" id="timestamp1"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image2" src="" title="Third of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label2"></p>
        </div>
        <div class="timestamp">
          <br><p class="timestamp" id="timestamp2"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image3" src="" title="Fourth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label3"></p>
        </div>
        <div class="timestamp">
          <br><p class="timestamp" id="timestamp3"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image4" src="" title="Fifth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label4"></p>
        </div>
        <div class="timestamp">
          <br><p class="timestamp" id="timestamp4"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image5" src="" title="Sixth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label5"></p>
        </div>
        <div class="timestamp">
          <br><p class="timestamp" id="timestamp5"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image6" src="" title="Seventh of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label6"></p>
        </div>
        <div class="timestamp">
          <br><p class="timestamp" id="timestamp6"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image7" src="" title="Eigth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label7"></p>
        </div>
        <div class="timestamp">
          <br><p class="timestamp" id="timestamp7"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image8" src="" title="Ninth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label8"></p>
        </div>
        <div class="timestamp">
          <br><p class="timestamp" id="timestamp8"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image9" src="" title="Tenth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label9"></p>
        </div>
        <div class="timestamp">
          <br><p class="timestamp" id="timestamp9"></p>
        </div>
      </div>


  </body>
  <script type="text/javascript">
    // WebSocket stuff
    var serverConnError = false
    const ws = new WebSocket('ws://raspberrypi:9898/');

    // ------------------------------------------------------------------------------------
    // Method for WebSocket Connection initialization event 
    ws.onopen = function() {
      console.log('WebSocket Client Connected');
      if (!serverConnError) {
        ws.send('getLast10Images');
      } else {
        alert("Failed to connect to NodeJS Server")
      }
    };
    
    // ------------------------------------------------------------------------------------
    // Method for WebSocket Connection error event - Update connection status
    ws.onerror = function(e) {
      alert("Failed to connect to Server Pi");
      serverConnError = true;
    };

    // ------------------------------------------------------------------------------------
    // Method for WebSocket Message received event.
    // Handle JSON formatted string passed from NodeJS WebSocket server to HTML client.
    // Based on serverData.cmdResponse field, update corresponding HTML client webpage fields/tables.
    ws.onmessage = function(e) {
      var dataAvailable = true; // Boolean flag to check if data received from NodsJS/SQL DB.
      console.log(JSON.parse(e.data)); // Allows user to view/debug data from webpage console.
      serverData = JSON.parse(e.data);
      // Check if data received from Server Pi SQL DB - used for error handling in message types below.
      if(serverData.numImages == 0) {
        alert("Failed to retrieve data from Server Pi");
          dataAvailable = false;
      }
      
      if (serverData.cmdResponse == "getLast10Images")
      { // Handle getLast10Images event - populate corresponding images and metadata with returned data.
        if (dataAvailable) {
          for (i = 0; i < serverData.numImages; i++) {
            document.getElementById("image" + i).src = serverData.images[i].url;
            document.getElementById("label" + i).innerHTML = "Auto-Generated Image Label";
            document.getElementById("timestamp" + i).innerHTML = "Time of classification.";
            // TODO: Labels from MySQL
            // TODO: Timestamps from MySQL
          }
          // // If less than 10 MySQL DB values returned my MySQL DB, popualte with "-"
          // for(i = serverData.numImages; i < 10; i++) {
          //   document.getElementById("timestamp" + i).innerHTML = "-";
          //   document.getElementById("nodeHumidity" + i).innerHTML = "-";
          // }
        }
      }
    };

    // ------------------------------------------------------------------------
    // Function for "Next 10 Images button"
    function loadNextTenImages() {
      
    }

    // ------------------------------------------------------------------------
    // Function for "Next 10 Images button"
    function prevNextTenImages() {
      
    }
  </script>
</html>