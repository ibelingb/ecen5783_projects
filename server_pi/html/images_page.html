<!DOCTYPE html>
<meta charset="utf-8"/>
<!--
The Magic Wand SuperProject HTML page (iamge detail page)
ECEN 5783 - Embedded Interface Design
11/16/2019
Authors: Brian Ibeling and Connor Shapiro

The images_page.html page shows users the ten most-recently classified images
with buttons allowing the user to move back and forth in time, ten images per
click. 

The HTML page reports to the user the following error/warning conditions:
  - Connection to Server Pi WebSocket fails
  - Any transaction between Server Pi and page fails

+ Resources and Citations +
The following resources were used to assist with development of this SW.
  - https://w3schools.com/  (too many helpful pages on HTML tags and javascript tips to list)
-->

<html>
  <head>
    <title>Magic Wand Dashboard</title>

    <style>
      h1 {
        text-align: center;
      }

      h2 {
        text-align: center;
      }

      .topButtons {
        text-align: center;
      }

      .button {
        background: none;
        border: none;
      }

      .available {
        font-weight: bold;
      }

      .unavailable {
        color: grey;
      }

      .imageHolder {
        width: 50%;
        height: 450px;
        margin: auto;
      }

      .image {
        width: 65%;
        height: 100%;
        float: left;
      }

      img.center {
        display: block;
        margin-left: auto;
        margin-right: 0%;
      }

      p.caption {
        text-align: right;
        font-size: 18px;
        margin-right: 5%;
      }

      .timestamp {
        width: 35%;
        height: 100%;
        float: right;
      }

      p.datestamp {
        margin-bottom: 0%;
        padding-left: 3px;
      }

      p.timestamp {
        width: 100%;
        float: left;
        padding-left: 5px;
        margin-top: 0%;
      }

    </style>

  </head>
  <body>
    <div>
      <h1>Magic Wand Image Webpage</h1>
      <!-- 
        The previous/next buttons change from black & functional to grey and
        non-functional as they become usable or unusable based on where in the
        image index the user is.
       -->
      <div class="topButtons">
        <input type="button" onclick="window.location.href = 'magicwand_webclient.html';" value="Back to Main Page">
        <br><br>
        <button disabled onclick="loadPrevTenImages()" class="button unavailable" id="previous">&lt;  Previous 10 Images</button>
        <button onclick="loadNextTenImages()" class="button available" id="next">Next 10 Images  &gt;</button>
      </div>
      <br>
      <!-- 
        The imageHolder div is used for each of the ten images, with
        subordinate elements inside.
       -->
      <div class="imageHolder">
        <div class="image">
          <img id="image0" src="" title="First of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label0"></p>
        </div>
        <div class="timestamp">
          <br><p class="datestamp" id="datestamp0"></p>
          <p class="timestamp" id="timestamp0"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image1" src="" title="Second of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label1"></p>
        </div>
        <div class="timestamp">
          <br><p class="datestamp" id="datestamp1"></p>
          <p class="timestamp" id="timestamp1"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image2" src="" title="Third of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label2"></p>
        </div>
        <div class="timestamp">
          <br><p class="datestamp" id="datestamp2"></p>
          <p class="timestamp" id="timestamp2"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image3" src="" title="Fourth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label3"></p>
        </div>
        <div class="timestamp">
          <br><p class="datestamp" id="datestamp3"></p>
          <p class="timestamp" id="timestamp3"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image4" src="" title="Fifth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label4"></p>
        </div>
        <div class="timestamp">
          <br><p class="datestamp" id="datestamp4"></p>
          <p class="timestamp" id="timestamp4"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image5" src="" title="Sixth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label5"></p>
        </div>
        <div class="timestamp">
          <br><p class="datestamp" id="datestamp5"></p>
          <p class="timestamp" id="timestamp5"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image6" src="" title="Seventh of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label6"></p>
        </div>
        <div class="timestamp">
          <br><p class="datestamp" id="datestamp6"></p>
          <p class="timestamp" id="timestamp6"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image7" src="" title="Eigth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label7"></p>
        </div>
        <div class="timestamp">
          <br><p class="datestamp" id="datestamp7"></p>
          <p class="timestamp" id="timestamp7"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image8" src="" title="Ninth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label8"></p>
        </div>
        <div class="timestamp">
          <br><p class="datestamp" id="datestamp8"></p>
          <p class="timestamp" id="timestamp8"></p>
        </div>
      </div>
      <div class="imageHolder">
        <div class="image">
          <img id="image9" src="" title="Tenth of ten current images." height="260" width="320" class="center">
          <br>
          <p class="caption" id="label9"></p>
        </div>
        <div class="timestamp">
          <br><p class="datestamp" id="datestamp9"></p>
          <p class="timestamp" id="timestamp9"></p>
        </div>
      </div>


  </body>
  <script type="text/javascript">

    // Global page count variable
    var pageCount = 0

    // WebSocket stuff
    var serverConnError = false
    const ws = new WebSocket('ws://raspberrypi:9898/');

    // ------------------------------------------------------------------------------------
    // Method for WebSocket Connection initialization event 
    ws.onopen = function() {
      console.log('WebSocket Client Connected');
      if (!serverConnError) {
        ws.send('get10Images');
      } else {
        alert("Failed to connect to NodeJS Server");
      }
    };
    
    // ------------------------------------------------------------------------------------
    // Method for WebSocket Connection error event - Update connection status
    ws.onerror = function(e) {
      alert("Failed to connect to Server Pi");
      serverConnError = true;
    };

    // ------------------------------------------------------------------------------------
    // Method for WebSocket Message received event.
    // Handle JSON formatted string passed from NodeJS WebSocket server to HTML client.
    // Based on serverData.cmdResponse field, update corresponding HTML client webpage fields/tables.
    ws.onmessage = function(e) {
      var correctStr  // Used to show classification correctness in label string
      var dataAvailable = true;  // Boolean flag to check if data received from NodsJS/SQL DB.
      console.log(JSON.parse(e.data)); // Allows user to view/debug data from webpage console.
      serverData = JSON.parse(e.data);
      // Check if data received from Server Pi SQL DB - used for error handling in message types below.
      if(serverData.numImages == 0) {
        alert("Failed to retrieve data from Server Pi");
          dataAvailable = false;
      }
      
      if (serverData.cmdResponse == "get10Images")
      { // Handle get10Images event - populate corresponding images and metadata with returned data.
        if (dataAvailable) {
          for (i = 0; i < serverData.numImages; i++) {

            var stamp = new Date(1000 * serverData.images[i].timestamp);
            // Some JS string operations will require an object for the timestamp

            document.getElementById("image" + i).src = "http://raspberrypi:50012/" + serverData.images[i].filename;
            if (0 == serverData.images[i].correctness) {
              correctStr = " (Classification Correct)";
            }
            else if (1 == serverData.images[i].correctness) {
              correctStr = " (Classification Incorrect)";
            }
            else {
              correctStr = " (Classification Unconfirmed)";
            }
            document.getElementById("label" + i).innerHTML = serverData.images[i].label + correctStr;
            document.getElementById("datestamp" + i).innerHTML = " Image classified on " + stamp.toDateString();
            document.getElementById("timestamp" + i).innerHTML =  "   at " + stamp.toLocaleTimeString();
          }

          // If less than 10 MySQL DB values returned my MySQL DB, popualte with "-"
          if (serverData.numImages < 10) {

            /* Reached end, no more next */
            next.setAttribute('disabled', 'disabled')
            if (document.getElementById("next").classList.contains("available")) {
              document.getElementById("next").classList.add("unavailable")
              document.getElementById("next").classList.remove("available")
            }

            for (i = serverData.numImages; i < 10; i++) {
              document.getElementById("image" + i).src = "http://raspberrypi:50012/maxresdefault.jpg";
              document.getElementById("label" + i).innerHTML = "End of oldest images.";
              document.getElementById("datestamp" + i).innerHTML = " End of oldest images.";
              document.getElementById("timestamp" + i).innerHTML =  "";
            }
          }
        }
      }
    };

    // ------------------------------------------------------------------------
    // Function for "Next 10 Images button"
    function loadNextTenImages() {
      if (!serverConnError) {
        ws.send('next10Images');
        pageCount += 1
        previous.removeAttribute('disabled')
        if (document.getElementById("previous").classList.contains("unavailable")) {
          document.getElementById("previous").classList.add("available")
          document.getElementById("previous").classList.remove("unavailable")
        }
      } else {
        alert("Failed to connect to NodeJS Server");
      }
    }

    // ------------------------------------------------------------------------
    // Function for "Next 10 Images button"
    function loadPrevTenImages() {
      if (!serverConnError) {
        ws.send('prev10Images');
        next.removeAttribute('disabled')
        if (document.getElementById("next").classList.contains("unavailable")) {
          document.getElementById("next").classList.add("available")
          document.getElementById("next").classList.remove("unavailable")
        }

        if (pageCount < 2) {
          previous.setAttribute('disabled', 'disabled')
          if (document.getElementById("previous").classList.contains("available")) {
            document.getElementById("previous").classList.add("unavailable")
            document.getElementById("previous").classList.remove("available")
          }
        }
        if (pageCount > 0) {
          pageCount -= 1
        }

      } else {
        alert("Failed to connect to NodeJS Server");
      }  
    }

  </script>
</html>