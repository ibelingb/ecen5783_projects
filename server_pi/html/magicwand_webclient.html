<!DOCTYPE html>
<meta charset="utf-8"/>
<!--
Project 3 HTML page
ECEN 5783 - Embedded Interface Design
10/14/2019
Authors: Brian Ibeling and Connor Shapiro

The project3_webclient.html page provides a browser-based HTML client interface
to communicate with the AWS Simple Queue Service (SQS), specifically supporting
pulling down JSON-formatted humidity/temperature records from the queue which
have been generated by a Raspberry Pi pushing the records into AWS (first via
AWS IoT, then through AWS Lambda to the queue).
EXTRA CREDIT: This page also provides an approximate count of the number of
records in the queue.

The HTML page reports to the user the following error/warning conditions:
  - Request for message(s) from SQS fails
  - Request for message(s) from SQS cannot be completed because queue is empty
  - Request for approx. number of messages in queue is not fulfilled by SQS

+ Resources and Citations +
The following resources were used to assist with development of this SW.
  - https://w3schools.com/  (too many helpful pages on HTML tags and javascript tips to list)
  - https://developers.google.com/chart/interactive/docs
-->

<html>
  <head>
    <title>Magic Wand Dashboard</title>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script> 

    <style>
      h1 {
        text-align: center;
      }

      h2 {
        text-align: center;
      }

      .centerRow {
        width: 90%;
        height: 450px;
        margin: auto;
      }

      .image {
        width: 50%;
        height: 100%;
        float: left;
        text-align: center;
      }

      img.center {
        display: block;
        margin-left: auto;
        margin-right: auto;
      }

      p.caption {
        text-align: center;
        font-size: 18px;
      }

      .performance {
        width: 50%;
        height: 100%;
        float: right;
        text-align: center;
      }

      .imagePerf {
        width: 50%;
        height: 100%;
        float: left;
        text-align: center;
      }

      .voicePerf {
        width: 50%;
        height: 100%;
        float: right;
        text-align: center;
      }

      .bottomRow {
        width: 90%;
        /* height: px; */
        margin: auto;
      }

    </style>

  </head>
  <body onload="startup()">
    <div>
      <!-- 

       -->
      <h1>Magic Wand Administration Webpage</h1>
      <br><br><br>
      <!--

      -->
      <section class="centerRow">
        <div class="image">
          <h2>Most Recent Image</h2>
          <br>
          <img id="recentImage" src="" title="Most recent image classified by the magic wand." height="260" width="320" class="center">
          <br>
          <p class="caption" id="imageLabel"></p>
        </div>
        <div class="performance">
          <h2>System Performance</h2>
          <div class="systemPerformance">
            <div class="imagePerf">
              <div id="imagePie"></div>
              <p class="caption">Image Classification</p>
            </div>
            <div class="voicePerf">
              <div id="voicePie"></div>
              <p class="caption">Voice Command Recognition</p>
            </div>
          </div>
        </div>
      </section>
      <br><br><br>
      <!--

      -->
      <section class="bottomRow">
        <div class="image">
          <h2>See All Images</h2>
          <input type="button" onclick="window.location.href = 'images_page.html';" value="Click Here">
        </div>
        <div class="performance">
          <h2>Performance Details</h2>
          <input type="button" onclick="window.location.href = 'performance_page.html';" value="Click Here">
        </div>
      </section>
  </body>
  <script type="text/javascript">
    // Load Google charts API for pi charts
    google.charts.load('current', {'packages':['corechart']});

    // WebSocket stuff
    var serverConnError = false
    const ws = new WebSocket('ws://raspberrypi:9898/');

    // ------------------------------------------------------------------------------------
    // Method for WebSocket Connection initialization event 
    ws.onopen = function() {
      console.log('WebSocket Client Connected');
      if (!serverConnError) {
        ws.send('getLatestImage');
      } else {
        alert("Failed to connect to NodeJS Server")
      }
    };
    
    // ------------------------------------------------------------------------------------
    // Method for WebSocket Connection error event - Update connection status
    ws.onerror = function(e) {
      alert("Failed to connect to Server Pi");
      serverConnError = true;
    };

    // ------------------------------------------------------------------------------------
    // Method for WebSocket Message received event.
    // Handle JSON formatted string passed from NodeJS WebSocket server to HTML client.
    // Based on serverData.cmdResponse field, update corresponding HTML client webpage fields/tables.
    ws.onmessage = function(e) {
      var dataAvailable = true; // Boolean flag to check if data received from NodsJS/SQL DB.
      console.log(JSON.parse(e.data)); // Allows user to view/debug data from webpage console.
      serverData = JSON.parse(e.data);
      // Check if data received from Server Pi SQL DB - used for error handling in message types below.
      if (serverData.numImages == 0) {
        alert("Failed to retrieve data from Server Pi");
          dataAvailable = false;
      }
      // Handle getLatestDbData event - populate latestDbData string on webpage with received data.
      if (serverData.cmdResponse == "getLatestImage") {
        if (dataAvailable) {
          document.getElementById("recentImage").src = "http://raspberrypi:50012/" + serverData.images[0].filename;
          document.getElementById("imageLabel").innerHTML = serverData.images[0].label;
        }
      }
    };


    // ------------------------------------------------------------------------
    // Function to populate the Most Recent Image image and the System
    // Performance pie charts when the webpage loads
    function startup() {

      var chartOptions = {
        height: 296, // Right now this is how I am aligning captions
        colors: ['#1E3231', '#485665', '#D0A5C0']
      };

      // Gather most recent image w/ label & correctness and populate image div
      // TODO: Gather from server pi

      document.getElementById("imageLabel").innerHTML = "Auto-Generated Image Label";
      // TODO: Correctness indicator

      // Gather performance metrics and populate pi charts
      // TODO: Gather from server pi

      var imageData = google.visualization.arrayToDataTable([
        ['Quality', 'Quantity'],
        ['Correct', 20],
        ['Incorrect', 3],
        ['Unconfirmed', 2]
      ]);

      var imageChart = new google.visualization.PieChart(document.getElementById('imagePie'));
      imageChart.draw(imageData, chartOptions);

      var voiceData = google.visualization.arrayToDataTable([
        ['Quality', 'Quantity'],
        ['Valid', 45],
        ['Recognized', 6],
        ['Unrecognized', 1]
      ]);
      var voiceChart = new google.visualization.PieChart(document.getElementById('voicePie'));
      voiceChart.draw(voiceData, chartOptions);
      
    }
  </script>
</html>