<!DOCTYPE html>
<meta charset="utf-8"/>
<!--
Project 3 HTML page
ECEN 5783 - Embedded Interface Design
10/14/2019
Authors: Brian Ibeling and Connor Shapiro

The project3_webclient.html page provides a browser-based HTML client interface
to communicate with the AWS Simple Queue Service (SQS), specifically supporting
pulling down JSON-formatted humidity/temperature records from the queue which
have been generated by a Raspberry Pi pushing the records into AWS (first via
AWS IoT, then through AWS Lambda to the queue).
EXTRA CREDIT: This page also provides an approximate count of the number of
records in the queue.

The HTML page reports to the user the following error/warning conditions:
  - Request for message(s) from SQS fails
  - Request for message(s) from SQS cannot be completed because queue is empty
  - Request for approx. number of messages in queue is not fulfilled by SQS

+ Resources and Citations +
The following resources were used to assist with development of this SW.
  - https://jqueryui.com/button/
  - https://www.w3schools.com/html/html_tables.asp
  - https://www.w3schools.com/jsref/jsref_gettime.asp
  - https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/getMilliseconds
  - https://stackoverflow.com/questions/3552461/how-to-format-a-javascript-date
  - https://www.w3schools.com/tags/att_input_type_radio.asp
  - https://docs.aws.amazon.com/code-samples/latest/catalog/javascript-browserstart-polly.html.html
  - https://docs.aws.amazon.com/en_pv/code-samples/latest/catalog/javascript-sqs-sqs_receivemessage.js.html
-->

<html>
  <head>
    <title>ECEN 5783 Project-3 Client Webpage</title>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <!-- <link rel="stylesheet" href="/resources/demos/style.css"> -->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <!--Load the AWS JavaScript SDK       -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.549.0.min.js"></script>
    <!--Load the AWS credentials -->
    <script type="text/javascript" src="credentials.js"></script> 

    <style>
      table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 70%;
      }

      td, th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 5px;
      }

      tr:nth-child(even) {
          background-color: #dddddd;
      }
    </style>

  </head>
  <body>
    <div class="widget">
      <!-- Define Webpage heading with buttons and text fields for latest DB data, current Sensor data, 
      and test server responsiveness -->
      <h1>ECEN5873 Project-3 Client Webpage</h1>
      <p>Display Temperature as:</p>
      <input type="radio" name="tempUnits" id="celsius" value="celsius" onchange="updatePageTemp();" checked="checked"> Celsius<br>
      <input type="radio" name="tempUnits" id="fahrenheit" value="fahrenheit" onchange="updatePageTemp();"> Fahrenheit<br>
      <br>
      <input onclick="getOneRecord()" type="submit" value="Get One SQS Record">
      <p id="oneErrMessage"></p>
      <input onclick="getAllRecords()" type="submit" value="Get All SQS Records">
      <p id="allErrMessage"></p>
      <input onclick="updateMessageCount()" type="submit" value="Display Number of SQS Records">
      <p id="currentMessageCount">Awaiting transaction from AWS</p>

      <!-- Define Data Table -->
      <h2>Twenty Most Recent Temperature/Humidity Readings</h2>
      <table>
        <tr>
          <th>Timestamp</th>
          <th>Temperature</th>
          <th>% Humidity</th>
        </tr>
        <tr>
          <td id=timestamp0>-</td>
          <td id=temperature0>-</td>
          <td id=humidity0>-</td>
        </tr>
        <tr>
          <td id=timestamp1>-</td>
          <td id=temperature1>-</td>
          <td id=humidity1>-</td>
        </tr>
        <tr>
          <td id=timestamp2>-</td>
          <td id=temperature2>-</td>
          <td id=humidity2>-</td>
        </tr>
        <tr>
          <td id=timestamp3>-</td>
          <td id=temperature3>-</td>
          <td id=humidity3>-</td>
        </tr>
        <tr>
          <td id=timestamp4>-</td>
          <td id=temperature4>-</td>
          <td id=humidity4>-</td>
        </tr>
        <tr>
          <td id=timestamp5>-</td>
          <td id=temperature5>-</td>
          <td id=humidity5>-</td>
        </tr>
        <tr>
          <td id=timestamp6>-</td>
          <td id=temperature6>-</td>
          <td id=humidity6>-</td>
        </tr>
        <tr>
          <td id=timestamp7>-</td>
          <td id=temperature7>-</td>
          <td id=humidity7>-</td>
        </tr>
        <tr>
          <td id=timestamp8>-</td>
          <td id=temperature8>-</td>
          <td id=humidity8>-</td>
        </tr>
        <tr>
          <td id=timestamp9>-</td>
          <td id=temperature9>-</td>
          <td id=humidity9>-</td>
        </tr>
        <tr>
          <td id=timestamp10>-</td>
          <td id=temperature10>-</td>
          <td id=humidity10>-</td>
        </tr>
        <tr>
          <td id=timestamp11>-</td>
          <td id=temperature11>-</td>
          <td id=humidity11>-</td>
        </tr>
        <tr>
          <td id=timestamp12>-</td>
          <td id=temperature12>-</td>
          <td id=humidity12>-</td>
        </tr>
        <tr>
          <td id=timestamp13>-</td>
          <td id=temperature13>-</td>
          <td id=humidity13>-</td>
        </tr>
        <tr>
          <td id=timestamp14>-</td>
          <td id=temperature14>-</td>
          <td id=humidity14>-</td>
        </tr>
        <tr>
          <td id=timestamp15>-</td>
          <td id=temperature15>-</td>
          <td id=humidity15>-</td>
        </tr>
        <tr>
          <td id=timestamp16>-</td>
          <td id=temperature16>-</td>
          <td id=humidity16>-</td>
        </tr>
        <tr>
          <td id=timestamp17>-</td>
          <td id=temperature17>-</td>
          <td id=humidity17>-</td>
        </tr>
        <tr>
          <td id=timestamp18>-</td>
          <td id=temperature18>-</td>
          <td id=humidity18>-</td>
        </tr>
        <tr>
          <td id=timestamp19>-</td>
          <td id=temperature19>-</td>
          <td id=humidity19>-</td>
        </tr>
      </table>
    </div>
  </body>
  <script type="text/javascript">
    // ------------------------------------------------------------------------------------
    // AWS Config
    AWS.config.region = 'us-east-1';
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
        IdentityPoolId: unauthPoolID, // unauthPoolID is set in credentials.js
                                      // which is not distrubuted via git
    });

    var sqs = new AWS.SQS({
      apiVersion: '2012-11-05',
      httpOptions: {
        xhrAsync: false  /* Need to specify this or else getAllRecords()
                          * ultimately gets us stuck in the while() loop until
                          * computer runs out of memory. This is due to the 
                          */
      }
    });

    var queueURL = "https://sqs.us-east-1.amazonaws.com/582548553336/project3Queue";

    // ------------------------------------------------------------------------------------
    // Global needed to pass data from AWS function context to caller
    var doneEmptyingQueue = false;
    // ------------------------------------------------------------------------------------
    // Verify Checkbox selected properly on webpage startup
    document.getElementById("celsius").checked = true;
  
    // ------------------------------------------------------------------------------------
    // Wrapper function called when "Get One SQS Record" button is pressed.
    function getOneRecord() {
    /* Attempt to get one message from AWS SQS queue,
     * handling possible empty queue & connection failure errors
     */

      var params = {
        QueueUrl: queueURL,
        MaxNumberOfMessages: 1,
        VisibilityTimeout: 10
      };

      // Request 1 messages from SQS
      sqs.receiveMessage(params, function(err, data) {
        if (err) {
          console.log("Receive Error", err);
          document.getElementById("oneErrMessage").innerHTML = "Failed to retrieve data from AWS SQS queue.";
        } else if (data.Messages.length) {
          
          pushRecordToTable(data.Messages)

          // Delete successfully received message from queue
          var deleteParams = {
            QueueUrl: queueURL,
            ReceiptHandle: data.Messages[0].ReceiptHandle
          };
          sqs.deleteMessage(deleteParams, function(err, data) {
            if (err) {
              console.log("Delete Error", err);
            } else {
              console.log("Message Deleted", data);
            }
          });

        // Handle case where SQS successfully tells us it is empty
        } else {
          console.log("SQS Queue empty.");
          document.getElementById("oneErrMessage").innerHTML = "AWS SQS queue is empty.";

          // Clear old message (if not cleared)
          document.getElementById("allErrMessage").innerHTML = "";
        }
      });

      // Get final count of messages remaining in queue
      updateMessageCount();
    }

    // ------------------------------------------------------------------------------------
    // Wrapper function called when "Get All SQS Records" button is pressed.
    function getAllRecords() {
      doneEmptyingQueue = false;  /* This global is updated inside of the
                                   * receiveMessage anonymous callback
                                   */
      var params = {
        QueueUrl: queueURL,
        MaxNumberOfMessages: 10, /* 10 is maximum qty of messages that can be requested at once from SQS
                                  * so we will attempt to get 10 at a time until empty
                                  */       
        VisibilityTimeout: 10
      };

      /* Request 10 messages from SQS, repeatedly, until there are none left */
      while (!doneEmptyingQueue) {
        sqs.receiveMessage(params, function(err, data) {
          var i;
          if (err) {
            console.log("Receive Error", err);
            document.getElementById("allErrMessage").innerHTML = "Failed to retrieve data from AWS SQS queue.";
          } else if (data.Messages.length) {
            
            pushRecordToTable(data.Messages);

            /* Delete successfully received messages from queue, deleting up 
             * to ten at a time with deleteMessageBatch() for speed
             */
            var deleteParams = {
              QueueUrl: queueURL,
              Entries: []
            };
            var entry;
            for (i = 0; i < data.Messages.length; i++) {
              entry = {
                Id: i.toString(),
                ReceiptHandle: data.Messages[i].ReceiptHandle
              }
              deleteParams.Entries.push(entry)
            }
            sqs.deleteMessageBatch(deleteParams, function(err, data) {
              if (err) {
                console.log("Delete Error", err);
              } else {
                console.log("Message(s) Deleted", data);
              }
            });
          } else {
            doneEmptyingQueue = true;
            console.log("SQS Queue empty.");
            document.getElementById("allErrMessage").innerHTML = "AWS SQS queue has been emptied.";

            // Clear old message (if not cleared)
            document.getElementById("oneErrMessage").innerHTML = "";
          }
        });
      }

      // Get final count of messages remaining in queue
      updateMessageCount();
    }

    // ------------------------------------------------------------------------------------
    // Function to update display of number of messages waiting in AWS SQS queue
    function updateMessageCount() {
      var params = {
        QueueUrl: queueURL,
        AttributeNames: [
          "ApproximateNumberOfMessages"
        ]
      };

      // Number of messages is stored in the queue's Attributes
      sqs.getQueueAttributes(params, function(err, data) {
        if (err) {
          console.log("Queue Attribute Error", err);
          document.getElementById("currentMessageCount").innerHTML =
            "Failed to retrieve number of messages in AWS SQS queue.";
        } else if (data) {
          console.log("Got Number of Messages", data);
          document.getElementById("currentMessageCount").innerHTML =
            "There are approximately " + data.Attributes.ApproximateNumberOfMessages
            + " messages in the AWS SQS queue."

          // Clear messages about queue being empty if it isn't anymore
          if (data.Attributes.ApproximateNumberOfMessages > 0) {
            document.getElementById("allErrMessage").innerHTML = "";
            document.getElementById("oneErrMessage").innerHTML = "";
          }
        }
      });
    }

    // ------------------------------------------------------------------------------------
    // Method to add JSON-formatted records (in SQS Messages format) to table
    function pushRecordToTable(SQSRecord) {
      var i;

      var quantity = SQSRecord.length;
      // This allows us to support any number of Messages in one object
      
      /* Shift records which are "old" down */
      if (quantity > 0) {  // Prevent accidentally trying to push 0 records
        for (i = 0; i < (20 - quantity); i++) {
          document.getElementById("timestamp" + (19 - i)).innerHTML = document.getElementById("timestamp" + (19 - i - quantity)).innerHTML;
          document.getElementById("temperature" + (19 - i)).innerHTML = document.getElementById("temperature" + (19 - i - quantity)).innerHTML;
          document.getElementById("humidity" + (19 - i)).innerHTML = document.getElementById("humidity" + (19 - i - quantity)).innerHTML;
        }

        /* This next bit is a bit odd. The SQS spec. claims "best-effort" is
         * made for messages to be received in order, however I could find
         * no reference to whether a batch of received messages is 
         * "best-effort" ordered [newest to oldest]:[0 to n]
         *                    or [newest to oldest]:[n to 0]
         * Intiutively it makes slightly more sense to me that the 0-indexed
         * message is oldest and the n-index is newest, and given that there is
         * no requirement in the project to treat them as anything other than
         * random order (and the fact that it was fun to figure out how to 
         * process in reverse order) that's the way I'll treat them.
         */
        for (i = quantity; i > 0; i--) {
          document.getElementById("timestamp" + (i - 1)).innerHTML = JSON.parse(SQSRecord[(quantity - i)].Body).timestamp;
          document.getElementById("temperature" + (i - 1)).innerHTML = displayTemp(JSON.parse(SQSRecord[(quantity - i)].Body).temperature);
          document.getElementById("humidity" + (i - 1)).innerHTML = JSON.parse(SQSRecord[(quantity - i)].Body).humidity;
        }
      }
    }

    // ------------------------------------------------------------------------------------
    // Display temperature on webpage based on
    // @temp - input temperature to convert to select units (C or F)
    // @return - Converted temperature string with unit designation
    function displayTemp(temp) {
      var tempStr = "";

      // If fahrenheit radio button selected, convert value; otherwise, simply return received value
      // Also, add units and return temp string
      if (document.getElementById("fahrenheit").checked == true) {
        temp = Math.round(((temp * (9/5)) + 32) * 10) / 10; // Convert celsius value to fahrenheit, rounded to be xx.x
        tempStr = temp + " F";
      } else {
        tempStr = temp + " C";
      }

      return tempStr;
    }

    // ------------------------------------------------------------------------------------
    // Method to update temp data displayed on webpage based on C/F radio button update event
    function updatePageTemp() {
      var i;
      var temp;
      var tempStr = "";

      // Call this just to make the message count responsive to every user input
      updateMessageCount();

      if (document.getElementById("fahrenheit").checked) {
        for (i = 0; i < 20; i ++) {

          // Only attempt to convert a populated celsius temperature
          if ("C" == document.getElementById("temperature" + i).innerHTML.substr(-1)) {
  
            // Convert to float (parser ignores whitespace and letters after numbers)
            temp = parseFloat(document.getElementById("temperature" + i).innerHTML)
            
            // Convert from C to F and format as string, then repopulate the value in table
            tempStr = (Math.round(((temp * (9/5)) + 32) * 10) / 10) + " F";
            document.getElementById("temperature" + i).innerHTML = tempStr;
          }
        }

      } else if (document.getElementById("celsius").checked) {
        for (i = 0; i < 20; i ++) {

          // Only attempt to convert a populated Fahrenheit temperature
          if ("F" == document.getElementById("temperature" + i).innerHTML.substr(-1)) {

            // Convert to float (parser ignores whitespace and letters after numbers)
            temp = parseFloat(document.getElementById("temperature" + i).innerHTML)
            
            // Convert from F to C and format as string, then repopulate the value in table
            tempStr = (Math.round(((temp - 32) * (5/9)) * 10) / 10) + " C";
            document.getElementById("temperature" + i).innerHTML = tempStr;
          }
        }
      }
    }
  </script>
</html>